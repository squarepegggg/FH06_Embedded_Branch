<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AccelDevice â€“ ML Prediction Dashboard</title>
<style>
  :root {
    --bg: #0f1117;
    --card: #1a1d27;
    --border: #2a2d3a;
    --text: #e1e4ed;
    --muted: #8b8fa3;
    --accent: #6366f1;
    --green: #22c55e;
    --red: #ef4444;
    --yellow: #eab308;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 24px 16px;
  }

  h1 {
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 4px;
  }
  .subtitle {
    color: var(--muted);
    font-size: 0.85rem;
    margin-bottom: 24px;
  }

  /* Connection bar */
  .conn-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 20px;
    margin-bottom: 24px;
    width: 100%;
    max-width: 520px;
  }
  .status-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: var(--red);
    flex-shrink: 0;
    transition: background 0.3s;
  }
  .status-dot.connected { background: var(--green); }
  .status-text {
    flex: 1;
    font-size: 0.9rem;
    color: var(--muted);
  }
  .status-text.connected { color: var(--green); }
  button {
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 8px 20px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  button:hover { opacity: 0.85; }
  button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
  button.disconnect {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
  }

  /* Current prediction hero */
  .hero {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px 24px;
    text-align: center;
    width: 100%;
    max-width: 520px;
    margin-bottom: 24px;
    transition: border-color 0.4s;
  }
  .hero.active { border-color: var(--accent); }
  .hero-label { color: var(--muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
  .hero-icon { font-size: 3.5rem; margin-bottom: 8px; }
  .hero-activity {
    font-size: 2rem;
    font-weight: 700;
    text-transform: capitalize;
    margin-bottom: 4px;
    transition: color 0.3s;
  }
  .hero-index { color: var(--muted); font-size: 0.8rem; }

  /* Activity grid */
  .grid-label { color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 10px; width: 100%; max-width: 520px; }
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 10px;
    width: 100%;
    max-width: 520px;
    margin-bottom: 24px;
  }
  .grid-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 12px;
    text-align: center;
    transition: border-color 0.3s, background 0.3s;
  }
  .grid-item.active {
    border-color: var(--accent);
    background: rgba(99,102,241,0.08);
  }
  .grid-item .icon { font-size: 1.4rem; margin-bottom: 4px; }
  .grid-item .name { font-size: 0.8rem; font-weight: 600; text-transform: capitalize; }
  .grid-item .count { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }

  /* Accelerometer card */
  .accel-label { color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 10px; width: 100%; max-width: 520px; }
  .accel-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    width: 100%;
    max-width: 520px;
    padding: 14px 16px;
    margin-bottom: 24px;
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 10px;
  }
  .axis {
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 8px;
    text-align: center;
    background: #161922;
  }
  .axis-name { display: block; color: var(--muted); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 3px; }
  .axis-value { display: block; color: var(--text); font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 0.95rem; font-weight: 600; }

  /* Log */
  .log-label { color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 10px; width: 100%; max-width: 520px; }
  .log {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    width: 100%;
    max-width: 520px;
    max-height: 260px;
    overflow-y: auto;
    padding: 12px 16px;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    line-height: 1.7;
  }

  /* Chart card */
  .chart-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    width: 100%;
    max-width: 520px;
    padding: 14px 16px;
    margin-bottom: 24px;
  }
  .chart-card canvas {
    width: 100%;
    height: 180px;
  }
  .log .entry { display: flex; gap: 10px; }
  .log .ts { color: #555; flex-shrink: 0; }
  .log .msg { }
  .log .msg.pred { color: var(--accent); font-weight: 600; }
  .log .msg.conn { color: var(--green); }
  .log .msg.err  { color: var(--red); }

  /* Responsive */
  @media (max-width: 400px) {
    .grid { grid-template-columns: repeat(2, 1fr); }
    .accel-card { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .hero-activity { font-size: 1.5rem; }
    .hero-icon { font-size: 2.5rem; }
  }
</style>
</head>
<body>

<h1>ğŸ§  AccelDevice Dashboard</h1>
<p class="subtitle">nRF52832 + BMA400 â†’ Edge Impulse ML over BLE</p>

<!-- Connection -->
<div class="conn-bar">
  <div class="status-dot" id="statusDot"></div>
  <span class="status-text" id="statusText">Disconnected</span>
  <button id="btnConnect" onclick="connectBLE()">Connect</button>
  <button id="btnDisconnect" class="disconnect" onclick="disconnectBLE()" disabled>Disconnect</button>
</div>

<!-- Hero prediction -->
<div class="hero" id="hero">
  <div class="hero-label">Current Activity</div>
  <div class="hero-icon" id="heroIcon">â³</div>
  <div class="hero-activity" id="heroActivity">Waitingâ€¦</div>
  <div class="hero-index" id="heroIndex">Connect to start receiving predictions</div>
</div>

<!-- Activity grid -->
<div class="grid-label">Activity Counts</div>
<div class="grid" id="activityGrid"></div>

<!-- Accelerometer Raw -->
<div class="accel-label">PCB Accelerometer â€” Raw (LSB) <span id="dataRate" style="float:right; color:#6366f1; font-weight:600;">0 sps</span></div>
<div class="accel-card">
  <div class="axis">
    <span class="axis-name">X</span>
    <span class="axis-value" id="accelX">--</span>
  </div>
  <div class="axis">
    <span class="axis-name">Y</span>
    <span class="axis-value" id="accelY">--</span>
  </div>
  <div class="axis">
    <span class="axis-name">Z</span>
    <span class="axis-value" id="accelZ">--</span>
  </div>
  <div class="axis">
    <span class="axis-name">|A|</span>
    <span class="axis-value" id="accelMag">--</span>
  </div>
</div>

<!-- Accelerometer m/sÂ² -->
<div class="accel-label">PCB Accelerometer â€” Physical (m/sÂ²)</div>
<div class="accel-card">
  <div class="axis">
    <span class="axis-name">X</span>
    <span class="axis-value" id="accelXms">--</span>
  </div>
  <div class="axis">
    <span class="axis-name">Y</span>
    <span class="axis-value" id="accelYms">--</span>
  </div>
  <div class="axis">
    <span class="axis-name">Z</span>
    <span class="axis-value" id="accelZms">--</span>
  </div>
  <div class="axis">
    <span class="axis-name">|A|</span>
    <span class="axis-value" id="accelMagMs">--</span>
  </div>
</div>

<!-- Accelerometer chart -->
<div class="accel-label">PCB Accelerometer History</div>
<div class="chart-card">
  <canvas id="accelChart" width="520" height="180"></canvas>
</div>

<!-- Log -->
<div class="log-label">Event Log</div>
<div class="log" id="log"></div>

<script>
// â”€â”€ BLE UUIDs (must match main.c) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SERVICE_UUID  = '12345678-1234-5678-1234-1234567890ab';
const CHAR_UUID     = '12345679-1234-5678-1234-1234567890ab';

// â”€â”€ Activity definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ACTIVITIES = [
  { id: 0, name: 'downstairs', icon: 'ğŸ”½', color: '#f97316' },
  { id: 1, name: 'jump',       icon: 'ğŸ¦˜', color: '#eab308' },
  { id: 2, name: 'running',    icon: 'ğŸƒ', color: '#ef4444' },
  { id: 3, name: 'sitting',    icon: 'ğŸª‘', color: '#22c55e' },
  { id: 4, name: 'standing',   icon: 'ğŸ§', color: '#3b82f6' },
  { id: 5, name: 'upstairs',   icon: 'ğŸ”¼', color: '#a855f7' },
  { id: 6, name: 'walking',    icon: 'ğŸš¶', color: '#6366f1' },
];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let device = null;
let characteristic = null;
const counts = new Array(7).fill(0);
let totalPredictions = 0;
let warnedLegacyPacket = false;
let lastLabel = -1;     // track to avoid redundant prediction UI updates
const accelHistory = { x: [], y: [], z: [] };

// â”€â”€ Data rate counter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let sampleCount = 0;
setInterval(() => {
  document.getElementById('dataRate').textContent = sampleCount + ' sps';
  sampleCount = 0;
}, 1000);

// â”€â”€ Build the activity grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const grid = document.getElementById('activityGrid');
ACTIVITIES.forEach(a => {
  const div = document.createElement('div');
  div.className = 'grid-item';
  div.id = `grid-${a.id}`;
  div.innerHTML = `
    <div class="icon">${a.icon}</div>
    <div class="name">${a.name}</div>
    <div class="count" id="count-${a.id}">0</div>`;
  grid.appendChild(div);
});

// â”€â”€ Logging helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(msg, cls = '') {
  const el = document.getElementById('log');
  const now = new Date().toLocaleTimeString('en-US', { hour12: false });
  el.innerHTML += `<div class="entry"><span class="ts">${now}</span><span class="msg ${cls}">${msg}</span></div>`;
  el.scrollTop = el.scrollHeight;
}

// â”€â”€ Update UI with a new prediction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onPrediction(index) {
  if (index > 6) { log(`Unknown label index: ${index}`, 'err'); return; }

  const a = ACTIVITIES[index];
  totalPredictions++;
  counts[index]++;

  // Hero
  document.getElementById('heroIcon').textContent = a.icon;
  document.getElementById('heroActivity').textContent = a.name;
  document.getElementById('heroActivity').style.color = a.color;
  document.getElementById('heroIndex').textContent =
    `Label ${index} Â· prediction #${totalPredictions}`;
  const hero = document.getElementById('hero');
  hero.classList.add('active');
  setTimeout(() => hero.classList.remove('active'), 600);

  // Grid
  ACTIVITIES.forEach(x => document.getElementById(`grid-${x.id}`).classList.remove('active'));
  document.getElementById(`grid-${index}`).classList.add('active');
  document.getElementById(`count-${index}`).textContent = counts[index];

  log(`${a.icon} ${a.name}  (index ${index}, total ${totalPredictions})`, 'pred');
}

function onAccelerometer(x, y, z) {
  sampleCount++;

  // Raw LSB values
  document.getElementById('accelX').textContent = x;
  document.getElementById('accelY').textContent = y;
  document.getElementById('accelZ').textContent = z;
  const mag = Math.sqrt((x * x) + (y * y) + (z * z));
  document.getElementById('accelMag').textContent = mag.toFixed(1);

  // Convert to m/sÂ²  (BMA400 8-bit FIFO, Â±4G: 1G = 512 LSB)
  const G = 9.80665;
  const LSB_PER_G = 512.0;
  const xMs = (x * G) / LSB_PER_G;
  const yMs = (y * G) / LSB_PER_G;
  const zMs = (z * G) / LSB_PER_G;
  const magMs = Math.sqrt(xMs * xMs + yMs * yMs + zMs * zMs);
  document.getElementById('accelXms').textContent = xMs.toFixed(2);
  document.getElementById('accelYms').textContent = yMs.toFixed(2);
  document.getElementById('accelZms').textContent = zMs.toFixed(2);
  document.getElementById('accelMagMs').textContent = magMs.toFixed(2);

  // Push to history for chart
  accelHistory.x.push(xMs);
  accelHistory.y.push(yMs);
  accelHistory.z.push(zMs);
  const MAX_HIST = 200;   // ~8 seconds of data at 25 samples/sec
  if (accelHistory.x.length > MAX_HIST) {
    accelHistory.x.shift();
    accelHistory.y.shift();
    accelHistory.z.shift();
  }
  scheduleChartRedraw();
}

// â”€â”€ Throttled chart redraw (cap at ~20fps to stay smooth) â”€â”€â”€
let chartRedrawScheduled = false;
function scheduleChartRedraw() {
  if (chartRedrawScheduled) return;
  chartRedrawScheduled = true;
  requestAnimationFrame(() => {
    drawAccelChart();
    chartRedrawScheduled = false;
  });
}

// â”€â”€ Accelerometer chart (pure canvas, no libs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawAccelChart() {
  const canvas = document.getElementById('accelChart');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;

  // Size the canvas for sharp rendering
  const rect = canvas.parentElement.getBoundingClientRect();
  const W = rect.width - 32; // account for padding
  const H = 180;
  canvas.width = W * dpr;
  canvas.height = H * dpr;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  // Background
  ctx.clearRect(0, 0, W, H);

  const data = accelHistory;
  if (data.x.length < 2) {
    ctx.fillStyle = '#8b8fa3';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Waiting for accelerometer dataâ€¦', W / 2, H / 2);
    return;
  }

  // Compute min/max across all axes
  const all = [...data.x, ...data.y, ...data.z];
  let minV = Math.min(...all);
  let maxV = Math.max(...all);
  if (maxV - minV < 1) { const mid = (maxV + minV) / 2; minV = mid - 1; maxV = mid + 1; }
  const pad = (maxV - minV) * 0.1;
  minV -= pad;
  maxV += pad;

  const n = data.x.length;
  const xStep = W / (n - 1);

  // Grid lines
  ctx.strokeStyle = '#2a2d3a';
  ctx.lineWidth = 0.5;
  for (let i = 0; i <= 4; i++) {
    const gy = (H / 4) * i;
    ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(W, gy); ctx.stroke();
  }

  // Y-axis labels
  ctx.fillStyle = '#555';
  ctx.font = '10px monospace';
  ctx.textAlign = 'left';
  for (let i = 0; i <= 4; i++) {
    const gy = (H / 4) * i;
    const val = maxV - (i / 4) * (maxV - minV);
    ctx.fillText(val.toFixed(1), 2, gy + 10);
  }

  // Draw line for an axis
  function drawLine(arr, color) {
    ctx.strokeStyle = color;
    ctx.lineWidth = 1.5;
    ctx.lineJoin = 'round';
    ctx.beginPath();
    for (let i = 0; i < n; i++) {
      const px = i * xStep;
      const py = H - ((arr[i] - minV) / (maxV - minV)) * H;
      if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
    }
    ctx.stroke();
  }

  drawLine(data.x, '#ef4444'); // red = X
  drawLine(data.y, '#22c55e'); // green = Y
  drawLine(data.z, '#3b82f6'); // blue = Z

  // Legend
  const legendY = 12;
  ctx.font = '10px sans-serif';
  const legends = [
    { label: 'X', color: '#ef4444' },
    { label: 'Y', color: '#22c55e' },
    { label: 'Z', color: '#3b82f6' },
  ];
  let lx = W - 90;
  legends.forEach(l => {
    ctx.fillStyle = l.color;
    ctx.fillRect(lx, legendY - 6, 8, 8);
    ctx.fillStyle = '#e1e4ed';
    ctx.fillText(l.label, lx + 11, legendY + 1);
    lx += 28;
  });
}

// â”€â”€ BLE notification handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onNotification(event) {
  const value = event.target.value;
  if (value.byteLength >= 7) {
    const label = value.getUint8(0);
    const x = value.getInt16(1, true);
    const y = value.getInt16(3, true);
    const z = value.getInt16(5, true);
    // Only update the ML prediction display when the label actually changes
    // (accel-only packets carry the cached label 0xFF or the last known label)
    if (label <= 6 && label !== lastLabel) {
      onPrediction(label);
      lastLabel = label;
    }
    onAccelerometer(x, y, z);
    return;
  }

  if (value.byteLength >= 1) {
    const byte = value.getUint8(0);
    onPrediction(byte);
    if (!warnedLegacyPacket) {
      log('Received legacy 1-byte packet (prediction only). Reflash latest firmware for accelerometer payload.', 'err');
      warnedLegacyPacket = true;
    }
    return;
  }

  log('Received empty BLE packet', 'err');
}

// â”€â”€ Connect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function connectBLE() {
  try {
    log('Scanning for AccelDeviceâ€¦', 'conn');
    device = await navigator.bluetooth.requestDevice({
      filters: [{ name: 'AccelDevice' }],
      optionalServices: [SERVICE_UUID],
    });

    device.addEventListener('gattserverdisconnected', () => {
      setConnected(false);
      log('Device disconnected', 'err');
    });

    log('Connecting to GATT serverâ€¦', 'conn');
    const server = await device.gatt.connect();

    log('Getting serviceâ€¦', 'conn');
    const service = await server.getPrimaryService(SERVICE_UUID);

    log('Getting characteristicâ€¦', 'conn');
    characteristic = await service.getCharacteristic(CHAR_UUID);

    log('Subscribing to notificationsâ€¦', 'conn');
    await characteristic.startNotifications();
    characteristic.addEventListener('characteristicvaluechanged', onNotification);

    setConnected(true);
    log('âœ… Connected & subscribed â€” waiting for predictions', 'conn');

  } catch (err) {
    log(`Error: ${err.message}`, 'err');
  }
}

// â”€â”€ Disconnect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function disconnectBLE() {
  if (device && device.gatt.connected) {
    device.gatt.disconnect();
  }
  setConnected(false);
}

// â”€â”€ UI state helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setConnected(connected) {
  document.getElementById('statusDot').className = 'status-dot' + (connected ? ' connected' : '');
  const st = document.getElementById('statusText');
  st.textContent = connected ? 'Connected to AccelDevice' : 'Disconnected';
  st.className = 'status-text' + (connected ? ' connected' : '');
  document.getElementById('btnConnect').disabled = connected;
  document.getElementById('btnDisconnect').disabled = !connected;
}
</script>

</body>
</html>
